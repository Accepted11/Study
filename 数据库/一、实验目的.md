### 一、实验目的

1. 掌握基本表的删除与修改；
2. 掌握实体完整性、参照完整性和用户定义的完整性的定义、检查和违约处理；
3. 掌握视图的定义、查询和更新，了解视图的作用。

### 二、实验学时

2 学时

### 三、实验内容

1. 完成以下操作：

   1. 向在实验二中所定义的数据表增加“备注”列，其数据类型为字符型，并查看新增列的值。

      ```sql
      alter table sumcostall add column note varchar(16);
      select *
      from sumcostall;
      ```

      ![image-20201223205031064](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205031064.png)

      ![image-20201223205118377](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205118377.png)

   2. 对上述数据表增加主码约束条件，并观察在数据表中存在数据的情况下主码约束是否创建成功，然后再次执行实验二中实验内容3-⑵的操作，并观察记录执行结果。

      ```sql
      alter table sumcostall
      add primary key (Unit,Date);
      select *
      from sumcostall;
      ```

      ```sql
      insert into sumCostALL(Unit,Date,Cost)
      select constructionUnit,MONTH(settleDate),sum(allCost)
      from costTable
      group by constructionUnit,MONTH(settleDate);
      select *
      from sumcostall;
      ```

      ![image-20201223205201057](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205201057.png)

   3. 删除上述数据表中的数据，然后再删除该数据表，对这两个操作进行比较。

      ```sql
      truncate table sumcostall;
      select * from sumcostall;
      ```

      ![image-20201223205225988](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205225988.png)

      ![image-20201223205233728](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205233728.png)

      ```sql
      drop table sumcostall;
      select * from sumcostall;
      ```

      ![image-20201223205256622](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205256622.png)

2. 完成以下任务：

   1. 对实验一中所定义的5 个数据表增加主码约束条件，并观察在数据表中存在数据的情况下主码约束是否创建成功，然后执行以下2 个操作，观察并记录实体完整性的检查和违约处理。

      ```sql
   alter table costtable
      add primary key (invoice);
   alter table departtable
      add primary key (departID);
   alter table materialcostdetail
      add primary key(invoice,materialId);
      alter table materiatable
      add primary key(materialId,materialName);
      alter table oilwalltable
      add primary key(oilWallId);
      ```
   
      ![image-20201223205316778](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205316778.png)
   
      ① insert into 材料消耗表values('zy2020001','wm004',100)
   
      ```sql
      insert into materialcostdetail value ('zy2020001','wm004',100);
      select * from materialcostdetail;
      ```
   
      ![image-20201223205335811](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205335811.png)
   
      ② insert into 材料消耗表values('zy2020002',NULL,200)
   
      ```sql
      insert into materialcostdetail value('zy2020002',NULL,200);
      ```
   
      ![image-20201223205354228](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205354228.png)
   
   2. 对实验一中所定义的5 个数据表增加相应的参照完整性约束，并观察在数据表中存在数据的情况下参照完整性约束是否创建成功，然后执行以下操作，观察并记录参照完整性的检查和违约处理。
   
      ```sql
      alter table oilwalltable add foreign key(departID) references departtable(departID);
      alter table costtable add foreign key(departmentId) references departtable(departID);
      alter table costtable add foreign key(oilWall) references oilwalltable(oilWallId);
      alter table materialcostdetail add foreign key(materialId) references materiatable(materialId);
      ```
   
      ![image-20201223205423246](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205423246.png)
   
      ① 将（y007 油井112203002）插入到油水井表。
   
      ```sql
      insert into oilwalltable
      value('y007','oilWall','112203002');
      ```
   
      ![image-20201223205440977](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205440977.png)
   
      ② insert into 材料消耗表values('zy2020007','wm006',100)
   
      ```sql
      insert into materialcostdetail
      value('zy2020007','wm006',100);
      ```
   
      ![image-20201223205459353](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205459353.png)
   
      ③ 将单位表中的（112202002 采油二矿二队）删除，查看油水井表和成本表中的数据有何变化。
   
      ```sql
      delete from departtable
      where departID = '112202002' and departName = 'oilTwoSecond';
      ```
   
      ![image-20201223205521132](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205521132.png)
   
      ④ 将材料表中的（wm004 材料四袋10）修改为（wm04 材料四袋10）。
   
      ```sql
      update materiatable
      set materialId = 'wm04'
      where materialId = 'wm004' and materialName = 'fourth';
      ```
   
      ![image-20201223205537349](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205537349.png)
   
      ⑤ 撤销上述成功的更新操作。
   
   3. 对实验一中所定义的5 个数据表按以下要求增加相应的完整性约束条件，并观察在数据表中存在数据的情况下完整性约束是否创建成功。
   
      ① 单位表的单位名称不能取空值、且取值唯一。
   
      ```sql
      alter table departtable add unique(departName) ;
      alter table departtable modify departName varchar(16) not null;
      ```
   
      ![image-20201223205557305](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205557305.png)
   
      ② 油水井表的井别只允许取“油井”或“水井”，单位代码不能取空值。
   
      ```sql
      alter table oilwalltable add check(oilWallType = 'oilWall' or oilWallType = 'waterWall');
      ```
   
      ![image-20201223205612319](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205612319.png)
   
      ③ 材料表的名称不能取空值、且取值唯一，计量单位不能取空值。
   
      ```sql
      alter table materiatable add unique(materialName,measureUnit);
      alter table materiatable modify materialName varchar(16) not null;
      ```
   
      ![image-20201223205627465](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205627465.png)
   
      ④ 材料消耗表的消耗数量不能取空值。
   
      ```sql
      alter table materialcostdetail modify consumeQuantity decimal(10,2) not null;
      ```
   
      ![image-20201223205642068](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205642068.png)
   
      ⑤ 对成本表根据实际应用的要求定义适当的用户定义的完整性约束条件。
   
      ```sql
      alter table costtable
      modify departmentId varchar(16) not null,
      modify oilWall varchar(16) not null ,
      modify budgetAmount decimal(10,2) not null,
      modify budgetPerson varchar(16) not null,
      modify budgetDate datetime not null;
      ```
   
      ![image-20201223205658156](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205658156.png)

3. 完成以下操作：

   1. 定义视图V1，用于保存成本表和材料消耗表的全部列。

      ```sql
      create view V1
      as
      select costtable.invoice as invoice,departmentId,oilWall,budgetAmount,
      budgetPerson,budgetDate,startDate,endDate,constructionUnit,
      constructionContent,materialCost,presonCost,equipmentCost
      otherCost,allCost,settlePreson,settleDate,recordAmount,recordPerson,
      recordDate,materialId,consumeQuantity
      from costtable,materialcostdetail
      where costtable.invoice = materialcostdetail.invoice;
      select *
      from V1;
      ```

      ![image-20201223205718005](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205718005.png)

      ![image-20201223205732348](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205732348.png)

   2. 查询上面定义的视图V1，可任意组合查询条件，构造出2 个查询。

      1. ```sql
         select invoice,materialId,consumeQuantity
         from V1
         where materialId = 'wm001';
         ```
         
   
   ​         ![image-20201223205834796](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205834796.png)
   
      2. ```sql
         select *
         from V1
         where invoice = 'zy2016001';
         ```
   
         ![image-20201223205858525](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205858525.png)
   
3. 定义一个反映成本表预算状态的视图V2，并向该视图插入('zy2020008','112202002','y005',10000,'张三', '2020-07-02')，查看成本表的数据有何变化。
   
   ```sql
   create view V2
   as
   select invoice,departmentId,oilWall,budgetAmount,budgetPerson,budgetDate
   from costtable;
   insert into V2
   value ('zy2020008','112202002','y005',10000,'张三', '2020-07-02');
   select *
   from V2;
   ```
   
   ![image-20201223205914315](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205914315.png)
   
   ![image-20201223205947669](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223205947669.png)
   
5. 撤销上述成功的更新操作。

   ```sql
   delete
   from costtable
   where invoice = 'zy2020008' and budgetPerson = '张三';
   select *
   from V2;
   ```

   ![image-20201223210004181](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223210004181.png)

   ![image-20201223210008942](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20201223210008942.png)

### 四、实验报告

提交实验内容中用SQL 语句完成的题目的SQL 语句文档及相应的执行结果。
