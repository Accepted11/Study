### 实验五、安全机制
#### 一、实验目的

1．掌握数据库安全管理机制中的常规方法，理解用户、模式、角色、权限的概念、定义及使用;

2．掌握视图、存储过程、触发器的概念、定义及如何发挥特殊的安全控制作用。

#### 二、实验学时
2学时
### 三、实验内容
1．理解用户、模式、角色、权限的概念，在MySQL中感知用户、模式、角色和权限。

2．完成以下操作：

⑴ 建立采油一矿的成本的视图，把该视图的查询权限授予给采油一矿的用户user11，以user11的身份查询该视图，观察执行情况；再以其他用户的身份查询该视图，观察执行情况。
创建用户user11：

```sql
create user 'user11' @'localhost' identified by '123456';
```
结果：

![image-20210101193112085](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20210101193112085.png)

![image-20210101193019316](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20210101193019316.png)

创建视图：

```sql
create view costTableView_OilOne
as
select *
from costtable
where departmentId in (
	select departID
    from departtable
	where departName like 'oilOne%');
select * from costTableView_OilOne;
```

结果：

![image-20210101193153072](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20210101193153072.png)

授权：

```sql
grant select on table zyxt.costTableView_OilOne to user11@'localhost';
```

结果;

![image-20210101193330961](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20210101193330961.png)

使用user11查看：

![image-20210101193524815](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20210101193524815.png)

⑵ 创建一个用户user12，以user12的身份执行实验四中所定义的存储过程，观察记录是否成功执行；然后把该存储过程的执行权限授予给user12，再次以user12的身份执行该存储过程，观察记录是否成功执行。

```sql
create user 'user12' @'localhost' identified by '123456';
select host,user from mysql.user;
```

结果：

![image-20210101193548213](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20210101193548213.png)

定义一个存储结构：

```sql
DELIMITER //
  CREATE PROCEDURE cost(in depertId varchar(16),start_Date datetime ,end_Date datetime)
    BEGIN
      declare allcost_no decimal(10,2) default 0.0;
      declare recordAmount_no decimal(10,2) default 0.0;
      declare  budgetAmount1 decimal(10,2) default 0.0;
      declare allCost1 decimal(10,2) default 0.0;
	  declare recordAmount1  decimal(10,2) default 0.0;
      select sum(budgetAmount) into budgetAmount1
      from costtable
      where departmentId like concat(depertId,'%') and startDate >= start_Date and endDate <= end_Date;
      
	  select sum(allCost) into allCost1
      from costtable
      where departmentId like concat(depertId,'%') and settleDate>=start_Date and settleDate<=end_Date;
      
       select sum(recordAmount) into recordAmount1
      from costtable
      where departmentId like concat(depertId,'%') and recordDate>=start_Date and recordDate<=end_Date;
      
      set allcost_no = budgetAmount1- allCost1;
      set recordAmount_no = allCost1 - recordAmount1;
      select  budgetAmount1 ,allCost1,recordAmount1,allcost_no,recordAmount_no;
    END
    //
DELIMITER ;
```

 结果：

![image-20210101194707356](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20210101194707356.png)

使用user12 调用：

![image-20210101195001732](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20210101195001732.png)

授予权限：

```sql
grant execute on procedure zyxt.cost to user11@'localhost';
```

结果：

![image-20210101195037088](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20210101195037088.png)

再次调用：

![image-20210101195119157](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20210101195119157.png)

⑶ 定义触发器，实现只能在工作时间内更新“成本表”的数据，然后通过选择不同的时间进行适当的更新操作来验证。

定义错误日志表（mysql8.0不支持返回）：

```sql
create table errorlog
(
	error_date datetime
);

```

![image-20210101195404908](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20210101195404908.png)

定义触发器：

```sql
DELIMITER //
create trigger costtable_t
after
update on costtable
for each row
begin
	if(DAYOFWEEK(CURRENT_TIMESTAMP())<7 or DAYOFWEEK(CURRENT_TIMESTAMP())>1)
	then
		insert into errorlog
        value(CURRENT_TIMESTAMP());
	end if;
end
    //
DELIMITER ;
```

![image-20210101195459561](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20210101195459561.png)

测试：

①时间：1.1——周五

```sql
update costTable 
set settlePreson = 'DogJiaojiao'
where invoice = 'zy2016001';
select * from errorlog;
```

![image-20210101195558829](C:\Users\shich\AppData\Roaming\Typora\typora-user-images\image-20210101195558829.png)

#### 四、实验报告
提交实验内容中用SQL语句完成的题目的SQL语句文档及相应的执行结果。